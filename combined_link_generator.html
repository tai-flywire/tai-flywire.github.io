<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
          integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css"
          integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
    <link rel="shortcut icon" href="https://www.flywire.com/media/img/favicon.ico"/>

    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script></script>

    <title>Flywire | Payment Link Generator</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            padding-top: 2em;
        }

        .jumbotron {
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 144 48' xmlns='http://www.w3.org/2000/svg' xmlns:xlink='http://www.w3.org/1999/xlink'%3E%3Cdefs%3E%3Cpath id='a' d='M143.871 23.97V.156H.01v47.625h143.861z'/%3E%3C/defs%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cpath fill='%230084C0' d='M30.433 37.626L36.399.156h4.844l-5.966 37.47h-4.844M60.024 36.905C58.878 44.198 54.607 48 47.887 48c-4.115 0-7.345-1.51-9.533-4.063l2.709-3.334c1.875 2.188 4.115 3.23 6.772 3.23 4.063 0 6.563-2.344 7.345-6.928l.312-1.824h-.104c-2.188 2.032-4.74 3.126-7.553 3.126-5.21 0-7.71-2.604-7.71-7.553 0-.938.104-1.928.26-3.022l2.446-15.414h4.792L45.23 27.632a11.29 11.29 0 00-.208 2.136c0 2.813 1.25 4.22 4.063 4.22 2.917 0 5.522-1.771 7.293-4.845l2.705-16.925h4.844l-3.903 24.687M114.538 16.802l1.025-4.678h-4.775l-4.064 25.567h4.845l2.151-13.724c.95-5.033 4.68-7.529 8.632-7.529.48 0 .831.001 1.217.038l.723-4.545c-4.568-.71-7.996 1.613-9.754 4.87M96.277 12.218l-7.946 17.69-2.828-17.69h-4.7l-8.173 17.69-2.694-17.69h-4.901l4.125 25.568h4.976l7.993-17.721 2.784 17.72h4.93l11.521-25.567h-5.087M97.97 37.786l4.062-25.568h4.845l-4.064 25.568H97.97M108.115 7.09a2.777 2.777 0 01-2.78 2.773 2.777 2.777 0 01-2.78-2.774 2.776 2.776 0 012.78-2.773 2.777 2.777 0 012.78 2.773'/%3E%3Cmask id='b' fill='%23fff'%3E%3Cuse xlink:href='%23a'/%3E%3C/mask%3E%3Cpath d='M130.868 33.936c-1.776.035-3.138-.484-4.036-1.539-.945-1.108-1.199-2.934-.792-5.425h7.08c2.137 0 5.021-.287 7.333-1.692 2.268-1.379 3.418-3.486 3.418-6.266 0-1.927-.83-3.819-2.275-5.19-1.682-1.595-4.088-2.437-6.959-2.437-10.503 0-11.784 7.449-12.814 13.436l-.367 2.284c-.442 3.19.152 5.766 1.817 7.873 1.548 1.96 4.198 3.039 7.463 3.039 10.572 0 11.531-8.89 11.531-8.89h-4.451s-.212 4.673-6.948 4.807zm-4.057-11.71c.781-4.33 3.445-6.713 7.502-6.713 2.972 0 4.893 1.411 4.893 3.596 0 2.681-1.903 3.93-5.99 3.93h-6.556l.151-.814zM18.075 19.29l.474-2.8H1.25l.71-4.45H19.25l.337-2.13C20.576 3.718 24.729.15 31.034.158h3.464l-.68 4.336-3.245-.004c-3.506-.005-5.509 1.73-6.143 5.6l-.31 1.951h6.685l-.708 4.45H23.42l-3.646 21.56c-.99 6.194-5.211 9.74-11.55 9.732l-.365-.003.74-4.699.236-.002c3.569.004 5.487-1.507 6.118-5.357L17.32 23.74H0l.71-4.45h17.365' fill='%230084C0' mask='url(%23b)'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-size: 500px;
            background-position-x: right;
        }

        .card {
            margin-bottom: 2em;
        }

        #actions-container {
            margin-top: 1em;
            display: none;
            justify-content: flex-end;
        }

        #actions-container button {
            margin-left: .75em;
        }

        #result {
            overflow-wrap: break-word;
            word-wrap: break-word;
            -ms-word-break: break-all;
            word-break: break-all;
            word-break: break-word;
        }

        .col-row-actions {
            font-size: 1.25em;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-end;
        }

        .row-action-icons {
            display: flex;
        }

        .row-action-icons i {
            cursor: pointer;
        }

        .row-action-icons i:hover {
            color: #007CFF;
        }

        .row-action-icons .fa-lock-open {
            color: #ccc;
        }

        .form-group.row:last-child, #generator-form {
            margin-bottom: 0;
        }

        .form-required {
            font-style: normal;
            font-weight: bold;
            color: #f00;
            margin-left: 0.5em;
        }

        .field-required {
            font-style: normal;
            color: #f00;
        }

        .alert > i {
            margin-right: 1em;
        }

        .btn > i {
            margin-right: .5em;
        }

        .loading-indicator {
            display: none;
            justify-content: center;
        }

        .portal-fields-cell {
            padding: 0 !important;
        }

        .portal-fields {
            width: 100%;
        }

        .portal-fields thead th {
            border-top-style: none;
        }

        table#portal-preview {
            display: none;
        }

        .spinner {
            background-color: #fff;
            opacity: 0.9;
            position: absolute;
            width: calc(100% - 2px);
            height: calc(100% - 2px);
            top: 1px;
            left: 1px;
            z-index: 2;
            border-radius: 3px;
            display: none;
            justify-content: center;
            align-items: center;
        }

        #logo-display {
            display: none;
            height: 80px;
            background: none no-repeat center/contain;
            margin-bottom: 2em;
        }

        /* Override Bootstrap */
        .btn-secondary:not(:disabled):not(.disabled).active, .btn-secondary:not(:disabled):not(.disabled):active, .show>.btn-secondary.dropdown-toggle {
            background-color: #333;
        }
    </style>
</head>
<body>

<!-- Set the value of the field below to lock the page to one portal code. -->
<input type="hidden" id="portalPreset" value="" data-env="prod">

<div class="container-lg">
    <div class="jumbotron">
        <h1 class="display-4">Code Generator</h1>
        <br/><br/>
        <small>* This feature is provided as a courtesy to customers as-is, with no warranty or support.</small>
    </div>

    <div id="logo-display"></div>

    <div class="card">
        <div class="card-header">
            Select the generator mode
        </div>
        <div class="card-body">
            <div class="btn-group btn-group-toggle btn-block" data-toggle="buttons">
                <label class="btn btn-success active">
                    <input type="radio" name="mode" value="gateway" checked=""> Intelligent Links
                </label>
                <label class="btn btn-success">
                    <input type="radio" name="mode" value="payment"> Payment Links
                </label>
                <label class="btn btn-success">
                    <input type="radio" name="mode" value="tokenized"> Tokenized links
                </label>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            Complete the fields below to proceed
            <i class="form-required" style="display: block; float: right;">* required field</i>
        </div>
        <div class="card-body">
            <div id="block-form" class="spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="sr-only">Loading...</span>
                </div>
            </div>
            <div class="form-group row">
                <label class="col-sm-5 col-form-label">Environment</label>
                <div class="col-sm-7">
                    <div class="btn-group btn-group-toggle" data-toggle="buttons">
                        <label class="btn btn-secondary active">
                            <input type="radio" name="env" id="prod" value="prod" checked> Production
                        </label>
                        <label class="btn btn-secondary">
                            <input type="radio" name="env" value="demo" id="demo"> Demo
                        </label>
                    </div>
                </div>
            </div>
            <form id="generator-form">
                <div class="form-group row">
                    <label for="provider" class="col-sm-5 col-form-label">Portal Code<i class="form-required">*</i></label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control" name="provider" id="provider" placeholder="3-letter code e.g. FLC" maxlength="3"/>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="payment_destination" class="col-sm-5 col-form-label">Subdomain<i class="form-required">*</i></label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control" name="payment_destination" id="payment_destination" placeholder="e.g. flywireclient"/>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="amount" class="col-sm-5 col-form-label">Amount to pay</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control" name="amount" id="amount" placeholder="e.g. 1000.00"/>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="max_amount" class="col-sm-5 col-form-label">Maximum Amount</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control" name="max_amount" id="max_amount" placeholder="e.g. 9999.00"/>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="return_cta" class="col-sm-5 col-form-label">Return CTA URL</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control" name="return_cta" id="return_cta" placeholder="e.g. http://www.university.edu/pay" maxlength="500"/>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="return_cta_name" class="col-sm-5 col-form-label">Return CTA Text</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control" name="return_cta_name" id="return_cta_name" placeholder="Text to be displayed as button. Default is &quot;Return to <institution>&quot;." maxlength="500"/>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="callback_url" class="col-sm-5 col-form-label">Callback URL</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control" name="callback_url" id="callback_url" placeholder="URL to send real-time status updates to e.g. http://www.university.edu/callback" maxlength="500"/>
                    </div>
                </div>
                <div class="form-group row">
                    <label for="callback_id" class="col-sm-5 col-form-label">Callback ID</label>
                    <div class="col-sm-7">
                        <input type="text" class="form-control" name="callback_id" id="callback_id" placeholder="Unique id for the transaction" maxlength="500"/>
                    </div>
                </div>
                <div class="form-group row" id="customFieldFormActions">
                    <label class="col-sm-5 col-form-label"></label>
                    <div class="col-sm-7">
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#customFieldModal">
                            <i class="fas fa-plus-circle" title="Add any custom field"></i> Add Field
                        </button>
                        <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#importModal" id="btn-open-import-modal">
                            <i class="fas fa-cloud-download-alt" title="Import a portal configuration"></i> Import Portal
                        </button>
                        <button type="button" class="btn btn-secondary" id="form-reset-button">
                            <i class="fas fa-undo-alt" title="Reset the form to original values"></i> Reset Form
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary btn-block btn-lg js-generate" disabled>
                    <div id="block-generate" class="spinner spinner-generate">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                    </div>
                    <i class="fas fa-cogs" title="Generate"></i> Generate <span class="js-generate-label">Intelligent Link</span>
                </button>
            </form>
        </div>
    </div>


    <div class="alert alert-secondary" id="display-container" role="alert">
        <div id="result-container">
            <span id="result">Fill out all required fields to see the result</span>
        </div>
        <div id="actions-container">
            <button type="button" class="btn btn-success btn-sm js-copy-link">
                <i class="far fa-fw fa-copy"></i>
                Copy Link
            </button>
            <button type="button" class="btn btn-success btn-sm js-open-link">
                <i class="fas fa-fw fa-external-link-alt"></i>
                Open Link
            </button>
        </div>
        <div id="error-container">
            <span id="error"></span>
        </div>
    </div>
</div>

<div class="modal fade" id="customFieldModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add Custom Field</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger" id="custom-error-display" style="display: none;">
                    <i class="fas fa-exclamation"></i><span></span>
                </div>
                <form id="custom-field-form">
                    <div class="form-group">
                        <label for="label">Label <i class="form-required">*</i></label>
                        <input type="text" class="form-control" name="label" id="label" placeholder="The name of the field as it will appear to the user"/>
                    </div>
                    <div class="form-group">
                        <label for="internalName">Internal Name <i class="form-required">*</i></label>
                        <input type="text" class="form-control" name="internalName" id="internalName" placeholder="Lowercase and underscores only e.g. student_full_name"/>
                    </div>
                    <!--<div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" name="isReadOnly" id="isReadOnly" checked>
                            <label class="custom-control-label" for="isReadOnly">Field cannot be edited by user</label>
                        </div>
                    </div>-->
                    <div class="form-group">
                        <div class="custom-control custom-switch">
                            <input type="checkbox" class="custom-control-input" name="isRequired" id="isRequired">
                            <label class="custom-control-label" for="isRequired">Field is required</label>
                        </div>
                    </div>
                    <input type="submit" style="display: none;">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-field-button">Save</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="importModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Import Portal Configuration</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger" id="import-error-display" style="display: none;">
                    <i class="fas fa-exclamation"></i><span></span>
                </div>

                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>Query the Flywire server for an existing portal configuration and import the settings into this link generator.
                </div>

                <form id="import-portal-form">
                    <div class="form-group">
                        <label for="portalCode">Portal Code <i class="form-required">*</i></label>
                        <input type="text" class="form-control" name="portalCode" id="portalCode" placeholder="3-letter code assigned by Flywire e.g. FLC" maxlength="3"/>
                    </div>
                </form>

                <div class="loading-indicator">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">Loading...</span>
                    </div>
                </div>

                <table class="table" id="portal-preview">
                    <colgroup>
                        <col style="width: 180px;">
                        <col style="width: auto;">
                    </colgroup>
                    <tbody>
                    <tr>
                        <th>Environment:</th>
                        <td class="js-env"></td>
                    </tr>
                    <tr>
                        <th>Institution Name:</th>
                        <td class="js-name"></td>
                    </tr>
                    <tr>
                        <th>Portal Code:</th>
                        <td class="js-code"></td>
                    </tr>
                    <tr>
                        <th>Subdomain:</th>
                        <td class="js-subdomain"></td>
                    </tr>
                    <tr>
                        <th>Fields:</th>
                        <td class="portal-fields-cell">
                            <table class="table portal-fields">
                                <thead>
                                <tr>
                                    <th>Label</th>
                                    <th>Internal Name</th>
                                </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="save-config-button" disabled>Import</button>
            </div>
        </div>
    </div>
</div>

<script>
    $( document ).ready(function() {
        const generator = new CodeGenerator();
    });

    class CodeGenerator {
        mode;
        env;
        payload = {};
        config = {
            el: {
                logo: document.getElementById('logo-display'),
                destination: document.getElementById('payment_destination'),
                result: document.getElementById('result'),
                resultContainer: document.getElementById('result-container'),
                error: document.getElementById('error'),
                errorContainer: document.getElementById('error-container'),
                actionsContainer: document.getElementById('actions-container'),
                displayContainer: document.getElementById('display-container'),
                generator: document.getElementById('generator-form'),
                customForm: document.getElementById('custom-field-form'),
                customModal: document.getElementById('customFieldModal'),
                customError: document.getElementById('custom-error-display'),
                importForm: document.getElementById('import-portal-form'),
                importSaveBtn: document.getElementById('save-config-button'),
                importModal: document.getElementById('importModal'),
                generateBtn: document.querySelector('.js-generate'),
                generateLabel: document.querySelector('.js-generate-label')
            },
            lockedMsg: 'User will not be able to edit this field.  Click to toggle.',
            unlockedMsg: 'User will be able to edit this field.  Click to toggle.'
        };
        urls = {
            prod: {
                gateway: 'https://gateway.flywire.com/v1/transfers?',
                payment: 'https://payment.flywire.com/pay/payment?',
                json: 'https://gateway.flywire.com/v1/transfers.json'
            },
            demo: {
                gateway: 'https://gateway.demo.flywire.com/v1/transfers?',
                payment: 'https://payment.demo.flywire.com/pay/payment?',
                json: 'https://gateway.demo.flywire.com/v1/transfers.json'
            }
        };

        constructor(config) {
            if (typeof config === 'object')
                Object.assign(this.config, config);

            this.mode = document.querySelector('input[name="mode"]:checked').value;
            this.env = document.querySelector('input[name="env"]:checked').value;
            this.setupEvents();
            this.loadDefaultPortal();
            // TODO: Reverse link generator - parse a given URL to populate form fields
        }

        setupEvents = () => {
            const that = this;
            document.getElementById('save-field-button').addEventListener('click', this.onClickSaveCustomField);
            document.getElementById('custom-field-form').addEventListener('submit', this.onClickSaveCustomField);
            document.getElementById('portalCode').addEventListener('input', this.onChangePortalCode);
            document.getElementById('generator-form').addEventListener('submit', e => {
                e.preventDefault();
                this.generate();
            });
            document.querySelector('.js-copy-link').addEventListener('click', this.onClickCopyLink);
            document.querySelector('.js-open-link').addEventListener('click', this.onClickOpenLink);
            document.querySelectorAll('input[name=env]').forEach(item => {
                item.addEventListener('click', this.onChangeEnv);
            });
            document.querySelectorAll('input[name=mode]').forEach(item => {
                item.addEventListener('click', this.onChangeMode);
            });

            document.getElementById('save-config-button').addEventListener('click', this.onSubmitImport);
            document.getElementById('import-portal-form').addEventListener('submit', this.onSubmitImport);

            $('#customFieldModal').on('shown.bs.modal', e => document.getElementById('label').focus());
            $('#importModal').on('shown.bs.modal', this.onShowImportModal);

            document.getElementById('form-reset-button').addEventListener('click', () => {
                this.resetGeneratorForm();
                this.showNothing();
            });

            document.addEventListener('input', function (e) {
                if (e.target.matches('form#generator-form input[type=text]'))
                    that.onChangeGeneratorFormField.call(e.target, e);
            }, false);

            document.getElementById('generator-form').addEventListener('click', function (e) {
                if (e.target.matches('.row-action-icons i.fa-trash-alt'))
                    that.onClickDeleteField.call(e.target, e);
            }, false);

            document.getElementById('generator-form').addEventListener('click', function (e) {
                if (e.target.matches('.row-action-icons i.fa-lock') || e.target.matches('.row-action-icons i.fa-lock-open'))
                    that.onClickLockField.call(e.target, e);
            }, false);
        }

        loadDefaultPortal = () => {
            const portalPreset = document.getElementById('portalPreset');

            if (portalPreset.value === '')
                return;

            const that = this,
                code = portalPreset.value,
                env = portalPreset.getAttribute('data-env'),
                demoURL = (env === 'prod') ? '' : '.demo',
                spinner = document.getElementById('block-form');

            document.getElementById('btn-open-import-modal').style.display = 'none';

            const request = new XMLHttpRequest();
            request.open('GET', `https://payment${demoURL}.flywire.com/v3/recipients/${code}`);

            spinner.style.display = 'flex';

            request.onload = function () {
                if (this.status >= 200 && this.status < 400) {
                    $(`input[name=env][value=${env}]`).closest('.btn').button('toggle');
                    const data = JSON.parse(this.response);
                    that.importPortal(data);
                    document.getElementById('provider').setAttribute('disabled', '');
                    document.getElementById('payment_destination').setAttribute('disabled', '');
                } else if (this.status === 404) {
                    console.error(`Unable to load details for portal ${code} on ${env}`);
                } else {
                    console.error("Sorry, an unknown error has occurred.  Please try again later.");
                }

                spinner.style.display = 'none';
            };

            request.onerror = function () {
                console.error("Sorry, an unknown error has occurred.  Please try again later.");
                spinner.style.display = 'none';
            };

            request.send();
        }

        previewPortalImport = data => {
            const previewTable = document.getElementById('portal-preview'),
                fieldsTable = document.querySelector('.table.portal-fields tbody'),
                saveBtn = this.config.el.importSaveBtn,
                isProd = this.env === 'prod';
            let isReq = false;

            document.querySelector('.js-env').innerHTML = isProd ? 'Production' : 'Demo';
            document.querySelector('.js-name').innerHTML = data.name;
            document.querySelector('.js-code').innerHTML = data.id;
            document.querySelector('.js-subdomain').innerHTML = data.subdomain;

            let field, row, labelCell, nameCell;

            for (let i = 0; i < data.fields.length; i++) {
                field = data.fields[i];
                isReq = field.required;
                row = document.createElement('tr');
                labelCell = document.createElement('td');
                nameCell = document.createElement('td');

                labelCell.innerHTML = `${isReq ? '<i class="field-required">' : ''}${field.view_options.label}${isReq ? '</i>' : ''}`;
                row.appendChild(labelCell);

                nameCell.innerHTML = `${isReq ? '<i class="field-required">' : ''}${field.id}${isReq ? '</i>' : ''}`;
                row.appendChild(nameCell);

                fieldsTable.appendChild(row);
            }

            previewTable.style.display = 'table';

            saveBtn.removeAttribute('disabled');
        }

        importPortal = data => {
            let field;
            const logoEl = this.config.el.logo;

            // reset
            this.resetGeneratorForm();
            //TODO: move reset into window close handler to prevent flash of old data

            document.getElementById('provider').value = data.id;
            this.payload.provider = {id: 'provider', value: data.id, isReadOnly: false};
            document.getElementById('payment_destination').value = data.subdomain;
            this.payload.payment_destination = {id: 'payment_destination', value: data.subdomain, isReadOnly: false};

            //TODO: Add support for field patterns
            //TODO: Show currency symbol for imported portal (remember to clear on reset)

            for (let i = 0; i < data.fields.length; i++) {
                field = data.fields[i];

                this.createCustomField({
                    label: field.view_options.label,
                    internalName: field.id,
                    hint: field.view_options.hint,
                    isReadOnly: true,
                    isRequired: field.required
                }, '#customFieldFormActions');
            }

            if (!!data.logo_url) {
                logoEl.style.backgroundImage = `url(${data.logo_url})`;
                logoEl.style.display = 'block';
            }

            this.generate();
        }

        createCustomField = (data, targetSelector) => {
            let fragment = new DocumentFragment(),
                group = document.createElement('div'),
                label = document.createElement('label'),
                actionsCol = document.createElement('div'),
                actionsDiv = document.createElement('div'),
                // lockIcon = document.createElement('i'),
                deleteIcon = document.createElement('i'),
                inputCol = document.createElement('div'),
                input = document.createElement('input'),
                isEditable = !data.isReadOnly,
                isRequired = !!data.isRequired && data.isRequired === 'on',
                requiredIndicator = document.createElement('i');

            group.classList.add('form-group', 'row', 'form-custom');
            fragment.appendChild(group);
            label.classList.add('col-sm-4', 'col-form-label');
            label.setAttribute('for', data.internalName);
            label.innerHTML = data.label;
            group.appendChild(label);
            actionsCol.classList.add('col-sm-1', 'col-row-actions');
            group.appendChild(actionsCol);
            actionsDiv.classList.add('row-action-icons');
            actionsCol.appendChild(actionsDiv);
            // lockIcon.classList.add('fas','fa-fw', isEditable ? 'fa-lock-open' : 'fa-lock');
            // lockIcon.setAttribute('title', isEditable ? unlockedMsg : lockedMsg);
            deleteIcon.classList.add('fas', 'fa-fw', 'fa-trash-alt');
            deleteIcon.setAttribute('title', 'Click to delete this field.')
            // actionsDiv.appendChild(lockIcon);
            actionsDiv.appendChild(deleteIcon);
            inputCol.classList.add('col-sm-7');
            group.appendChild(inputCol);
            input.classList.add('form-control', 'custom-field');
            input.setAttribute('type', 'text');
            input.setAttribute('id', data.internalName);
            if (!!data.hint) input.setAttribute('placeholder', data.hint);
            inputCol.appendChild(input);
            // TODO: display fields with value[] property as dropdowns
            // TODO: re-add lock icons for payment mode

            if (isRequired) {
                requiredIndicator.classList.add('form-required');
                requiredIndicator.innerHTML = '*';
                label.appendChild(requiredIndicator);
                input.setAttribute('required', '');
            }

            return document.querySelector(targetSelector).insertAdjacentElement('beforebegin', group);
        }

        validateGeneratorForm = () => {
            let isValid = false;

            if (this.mode === 'payment' && !!this.payload['provider'])
                isValid = true;
            else if ((this.mode === 'gateway' || this.mode === 'tokenized') && !!this.payload['provider'] && !!this.payload['payment_destination'])
                isValid = true;

            if (!isValid) {
                this.showNothing();
            } else if (!!this.payload.amount && !!this.payload.amount.value && isNaN(this.payload.amount.value)) {
                this.showError(`"${this.payload.amount.value}" is not a valid amount.  Please enter the amount in cents as a whole number.`);
            } else if (!!this.payload.max_amount && !!this.payload.max_amount.value && isNaN(this.payload.max_amount.value)) {
                this.showError(`"${this.payload.max_amount.value}" is not a valid amount.  Please enter the max amount in cents as a whole number.`);
            }

            if (isValid)
                this.config.el.generateBtn.removeAttribute('disabled');
            else
                this.config.el.generateBtn.setAttribute('disabled','');

            return isValid;
        }

        generate = isValidated => {
            if (!isValidated && !this.validateGeneratorForm())
                return;

            switch (this.mode) {
                case "tokenized":
                    this.generateTokenizedLink();
                    break;
                case "payment":
                default: // gateway mode
                    this.generateLink();
            }
        }

        generateLink = () => {
            const readOnly = [];
            let url = this.urls[this.env][this.mode],
                payload = this.payload;

            if (this.mode === 'payment') {
                payload.recipient = payload.provider;
                delete payload.provider;
                delete payload.payment_destination;
            }

            for (const propName in payload) {
                url += `${propName}=${encodeURIComponent(this.payload[propName].value)}&`;
                if (this.payload[propName].isReadOnly) readOnly.push(propName)
            }

            if (readOnly.length)
                url += `read_only=${readOnly.join()}&`;

            this.showResult(url.slice(0, -1));
        }

        generateTokenizedLink = () => {
            const that = this,
                request = new XMLHttpRequest(),
                json = {
                    "dynamic_fields": {}
                };
            let prop;

            request.open('POST', this.urls[this.env].json);
            request.setRequestHeader("Content-Type", "application/json");

            for (const propName in this.payload) {
                prop = this.payload[propName];
                if (prop.isCustom)
                    json.dynamic_fields[propName] = prop.value;
                else
                    json[propName] = prop.value.toString();
            }

            //spinner.style.display = 'flex';

            request.onload = function () {
                if (this.status >= 200 && this.status < 400) {
                    const data = JSON.parse(this.response);
                    that.showResult(data.url);
                } else if (this.status === 404) {
                    console.error(`Unable to load details for portal ${this.payload.provider} on ${this.env}`);
                } else {
                    console.error("Sorry, an unknown error has occurred.  Please try again later.");
                }

                //spinner.style.display = 'none';
            };

            request.onerror = function () {
                console.error("Sorry, an unknown error has occurred.  Please try again later.");
                //spinner.style.display = 'none';
            };

            request.send(json);
        }

        resetGeneratorForm = () => {
            const form = this.config.el.generator,
                logoEl = this.config.el.logo,
                customFieldRows = document.querySelectorAll('.form-custom');

            customFieldRows.forEach(row => row.parentNode.removeChild(row));

            form.reset();
            logoEl.style.backgroundImage = 'none';
            logoEl.style.display = 'none';

            /*//reset Bootstrap radio button
            for (let radio of document.querySelectorAll('input[name="env"]')) {
                if (radio.checked && !radio.parentNode.classList.contains('active'))
                    radio.parentNode.classList.add('active');
                else if (!radio.checked && radio.parentNode.classList.contains('active'))
                    radio.parentNode.classList.remove('active');
            }*/
        }

        showResult = result => {
            const el = this.config.el;
            el.result.innerHTML = result;
            el.errorContainer.style.display = 'none';
            el.actionsContainer.style.display = 'flex';
            el.resultContainer.style.display = 'block';

            el.displayContainer.classList.remove('alert-secondary', 'alert-danger');
            el.displayContainer.classList.add('alert-success');
        }

        showError = error => {
            const el = this.config.el;
            el.error.innerHTML = error;
            el.errorContainer.style.display = 'block';
            el.actionsContainer.style.display = 'none';
            el.resultContainer.style.display = 'none';

            el.displayContainer.classList.remove('alert-secondary', 'alert-success');
            el.displayContainer.classList.add('alert-danger');
        }

        showNothing = () => {
            const el = this.config.el;
            el.result.innerHTML = "Fill out all required fields to see the result";
            el.errorContainer.style.display = 'none';
            el.actionsContainer.style.display = 'none';
            el.resultContainer.style.display = 'block';

            el.displayContainer.classList.remove('alert-danger', 'alert-success');
            el.displayContainer.classList.add('alert-secondary');
        }

        onChangeGeneratorFormField = debounce(e => {
            const target = e.target,
                isReadOnly = target.closest('.form-group').querySelector('.fa-lock') !== null,
                isCustom = target.classList.contains('custom-field');
            let value;

            if (target.id === 'provider') {
                target.value = target.value.toUpperCase();
                value = target.value;
            } else if ((target.id === 'amount' || target.id === 'max_amount') && !isNaN(target.value)) {
                value = (parseNumber(target.value) * 100).toFixed(0);
            } else {
                value = target.value;
            }

            if (!value)
                delete this.payload[target.id];
            else
                this.payload[target.id] = {
                    id: target.id,
                    value: value,
                    isReadOnly
                };

            this.validateGeneratorForm();
        }, 400);

        onClickSaveCustomField = e => {
            e.preventDefault();

            const el = this.config.el,
                form = el.customForm,
                formData = new FormData(form),
                errorDisplay = el.customError;

            errorDisplay.querySelector('span').innerHTML = '';
            errorDisplay.style.display = 'none';

            let myField = {},
                errorMsg = '';
            for (let [key, value] of formData) {
                myField[key] = value;
            }

            // simple validation
            if (!myField.internalName) {
                errorMsg += 'Internal Name is required. ';
            } else if (!/^[a-z0-9_]+$/.test(myField.internalName)) {
                errorMsg += 'Internal Name must be lowercase (a-z), numbers and underscores only. '
            }

            if (!myField.label) {
                errorMsg += 'Label is required.';
            }

            if (errorMsg !== '') {
                errorDisplay.querySelector('span').innerHTML = errorMsg;
                errorDisplay.style.display = 'block';
                return;
            }

            // create new custom field HTML
            this.createCustomField(myField, '#customFieldFormActions');

            // reset custom field form
            form.reset();
            $(el.customModal).modal('hide');
        }

        onClickDeleteField = e => {
            const formGroup = e.target.closest('.form-group.row'),
                label = formGroup.querySelector('label');

            if (window.confirm(`Are you sure you want to delete the field "${label.innerText}"?`)) {
                formGroup.parentNode.removeChild(formGroup);
            }
        }

        onClickLockField = e => {
            const icon = e.target,
                field = icon.closest('.form-group').querySelector('input[type=text]');
            let isReadOnly = e.target.classList.contains('fa-lock');

            if (isReadOnly) {
                icon.classList.remove('fa-lock');
                icon.classList.add('fa-lock-open');
                icon.setAttribute('title', unlockedMsg);
                isReadOnly = false;
            } else {
                icon.classList.remove('fa-lock-open');
                icon.classList.add('fa-lock');
                icon.setAttribute('title', lockedMsg);
                isReadOnly = true;
            }

            this.validateGeneratorForm({
                id: field.id,
                value: field.value,
                isReadOnly
            });
        }

        onChangeEnv = e => {
            this.env = document.querySelector('input[name="env"]:checked').value;
            this.generate();
        }

        onChangeMode = e => {
            this.mode = document.querySelector('input[name="mode"]:checked').value;

            switch (this.mode) {
                case "payment":
                    this.config.el.destination.setAttribute('disabled', '');
                    this.config.el.generateLabel.innerHTML = 'Payment Link';
                    this.generate();
                    break;
                case "tokenized":
                    this.config.el.destination.removeAttribute('disabled');
                    this.config.el.generateLabel.innerHTML = 'Tokenized Link';
                    this.generate();
                    break;
                default: // gateway links
                    this.config.el.destination.removeAttribute('disabled');
                    this.config.el.generateLabel.innerHTML = 'Intelligent Link';
                    this.generate();
                    break;
            }
        }

        onChangePortalCode = e => {
            const target = e.target,
                code = target.value.toUpperCase();

            if (code.length < 3) return;

            const that = this,
                el = this.config.el,
                demoURL = (this.env === 'prod') ? '' : '.demo',
                errorDisplay = document.getElementById('import-error-display'),
                errorDisplayMsg = errorDisplay.querySelector('span'),
                spinner = document.querySelector('#importModal .loading-indicator'),
                previewTable = document.getElementById('portal-preview'),
                importBtn = el.importSaveBtn;

            errorDisplayMsg.innerHTML = '';
            errorDisplay.style.display = 'none';

            target.value = target.value.toUpperCase();

            const request = new XMLHttpRequest();
            request.open('GET', `https://payment${demoURL}.flywire.com/v3/recipients/${code}`);

            previewTable.style.display = 'none';
            document.querySelector('.portal-fields tbody').innerHTML = '';
            spinner.style.display = 'flex';

            request.onload = function () {
                spinner.style.display = 'none';

                if (this.status >= 200 && this.status < 400) {
                    // Success!
                    const data = JSON.parse(this.response);

                    errorDisplayMsg.innerHTML = '';
                    errorDisplay.style.display = 'none';

                    importBtn.setAttribute('data-portal', JSON.stringify(data));
                    that.previewPortalImport(data);
                } else if (this.status === 404) {
                    // Portal not found
                    errorDisplayMsg.innerHTML = `Portal "${code}" was not found on ${that.env ? 'production' : 'demo'}.  Did you mean to search ${that.env ? 'demo' : 'production'}?`;
                    errorDisplay.style.display = 'block';
                } else {
                    errorDisplayMsg.innerHTML = "Sorry, an unknown error has occurred.  Please try again later.";
                    errorDisplay.style.display = 'block';
                }
            };

            request.onerror = function () {
                errorDisplayMsg.innerHTML = "Sorry, an unknown error has occurred.  Please try again later.";
                errorDisplay.style.display = 'block';
            };

            request.send();
        }

        onSubmitImport = e => {
            e.preventDefault();
            const data = JSON.parse(document.getElementById('save-config-button').getAttribute('data-portal'));

            $(this.config.el.importModal).modal('hide');
            this.importPortal(data);
        }

        onShowImportModal = e => {
            const el = this.config.el,
                form = el.importForm,
                previewTable = document.getElementById('portal-preview'),
                portalField = document.getElementById('portalCode'),
                errorDisplay = document.getElementById('import-error-display'),
                errorDisplayMsg = errorDisplay.querySelector('span');

            form.reset();
            previewTable.style.display = 'none';
            errorDisplayMsg.innerHTML = '';
            this.config.el.errorContainer.style.display = 'none';
            portalField.focus();
        }

        onClickCopyLink = () => {
            const el = this.config.el,
                url = el.result.innerText;
            let tempElement = document.createElement('textarea');
            tempElement.value = url;
            tempElement.setAttribute('readonly', '');
            tempElement.style.position = 'absolute';
            tempElement.styleleft = '-9999px';
            document.body.appendChild(tempElement);
            tempElement.select();
            document.execCommand('copy');
            document.body.removeChild(tempElement);
        }

        onClickOpenLink = () => {
            window.open(this.config.el.result.innerText, '_blank');
        }
    }

    function debounce(callback, wait) {
        let timeout;
        return (...args) => {
            const context = this;
            clearTimeout(timeout);
            timeout = setTimeout(() => callback.apply(context, args), wait);
        };
    }

    function parseNumber(value) {
        const example = Intl.NumberFormat(navigator.language).format(1.1);
        const cleanPattern = new RegExp('[^-+0-9' + example.charAt(1) + ']', 'g');
        const cleaned = value.replace(cleanPattern, '');
        const normalized = cleaned.replace(example.charAt(1), '.');
        return parseFloat(normalized);
    }
</script>
</body>
</html>